---
title: "Divorce_TBMU"
author: "Thomas Merkling"
date: "11 July 2018"
output: html_document
---

```{r, warning = FALSE, message = FALSE, include = FALSE}
setwd("D:/Thomas/Google Drive/postdoc/FQRNT murre project/murre data/TBMU-divorce")
```

```{r}
library(dplyr)
library(glmmTMB)
library(MuMIn)
library(corrplot)
library(arm)
library(ggplot2)
```


# **1. Causes of divorce**

import data created with the master data
```{r}
TBMU_divorce = read.table("TBMU_Coats_divorce_data.csv", header = TRUE, sep = ",")
dim(TBMU_divorce) # 1460   18
```

for these analyses we are only interested in whether a pair remained together or divorced, so we'll discard all the mate switching due to an individual disappareance.
```{r}
TBMU_divorce = TBMU_divorce %>% filter(Outcome != "DEAD")
dim(TBMU_divorce) # 812  18
TBMU_divorce = TBMU_divorce %>% mutate(ProbDiv = if_else(Outcome == "DIV",1,0))
```

data exploration: how many missing data for each 
```{r }
table(is.na(TBMU_divorce$Laying))
table(is.na(TBMU_divorce$Fledge))
table(is.na(TBMU_divorce$AgeMale))
table(is.na(TBMU_divorce$AgeFemale))
table(is.na(TBMU_divorce$AgeBird1))
table(is.na(TBMU_divorce$AgeBird2))
table(is.na(TBMU_divorce$ExpMale))
table(is.na(TBMU_divorce$ExpFemale))
table(is.na(TBMU_divorce$ExpBird1))
table(is.na(TBMU_divorce$ExpBird2))
table(is.na(TBMU_divorce$PairBond))
table(is.na(TBMU_divorce$QLTY))
```
it's mostly for age and breeding experience that there are missing values and for fledging a bit too

Create a new variable for the study plot. Some experiments have been carried out on J and small sample size for N, so will not consider those 2.
```{r}
TBMU_divorce_clean = TBMU_divorce %>% dplyr::select(c(-Hatching,-Outcome)) %>% na.omit() %>% mutate(Plot = substr(Site,1,1)) %>% filter(Plot != "N" & Plot != "J")
TBMU_divorce_clean$BandNo1 = factor(TBMU_divorce_clean$BandNo1)
TBMU_divorce_clean$BandNo2 = factor(TBMU_divorce_clean$BandNo2)
TBMU_divorce_clean$Site = factor(TBMU_divorce_clean$Site)
```
removing all the observations with at least one NA leaves 320 observations!

```{r}
TBMU_divorce_outExp = TBMU_divorce %>% dplyr::select(c(-Hatching,-Outcome,-ExpMale,-ExpFemale,-ExpBird1,-ExpBird2,-PairBond)) %>% na.omit() %>% mutate(Plot = substr(Site,1,1))  %>% filter(Plot != "N" & Plot != "J")
```
if I include observations with unreliable info about breeding experience and pair-bond, it yields ~140 more observations (but can't have those variables in the models)

Is there variability among years and/or among plots in divorce rates?
```{r}
div_Year = TBMU_divorce_outExp %>% group_by(Year) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N_Year = n())
div_Plot = TBMU_divorce_outExp %>% group_by(Plot) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N_Plot = n())
```
```{r, include=FALSE}
Year_graph = ggplot(data = div_Year, aes(x = Year, y = PropDiv)) + geom_point(aes(size = N_Year)) + geom_errorbar(aes(ymin = PropDiv - SE_PropDiv, ymax = PropDiv + SE_PropDiv)) + theme_bw()
```
```{r}
Year_graph
```
divorce rates seem slightly lower in recent years...

```{r, include=FALSE}
Plot_graph = ggplot(data = div_Plot, aes(x = Plot, y = PropDiv)) + geom_point(aes(size = N_Plot)) + geom_errorbar(aes(ymin = PropDiv - SE_PropDiv, ymax = PropDiv + SE_PropDiv)) + theme_bw()
```
```{r}
Plot_graph
```
huge variation among plots, with much lower divorce rates and larger sample size in the Q plot. We know that data quality is much higher for the Q plot, and the observed average divorce rate is closer to what we'd expect, so probably better to focus only on Q plot...

```{r}
TBMU_divorce_cleanQ = TBMU_divorce_clean %>% filter(Plot == "Q")
TBMU_divorce_outExpQ = TBMU_divorce_outExp %>% filter(Plot == "Q")
```

collinearity among explanatory variables
```{r}
cor_div = cor(TBMU_divorce_cleanQ[,c(5,7:8,11:12,15:16)])
corrplot.mixed(cor_div, upper = "ellipse", lower = "number")
```
Logically age and experience are strongly correlated within a sex, but otherwise no very strong correlations. So age and experience will never be in the same model.
We also know that reproductive success varies with age in this species, so is there some collinearity with Fledge?

```{r}
source(file = "HighstatLib.R") 
```
this is an R code containing functions created by Zuur et al.

```{r}
corvif(TBMU_divorce_cleanQ[,c(5:8,15:16)])
```
VIFs suggest that there is no multicollinearity between ages, laying date, fledging probability, pair-bond and site quality

loooking at spread of data for ages, breeding experience and pair-bond to see if I need to group data
```{r, include=FALSE}
Age_graph = ggplot(data = TBMU_divorce_cleanQ, aes(x = AgeMale)) + geom_histogram(fill = "blue", bins = 20, alpha = 0.4) + geom_histogram(aes(x = AgeFemale), fill = "red", bins = 20, alpha = 0.4) + geom_histogram(data = TBMU_divorce_outExpQ, aes(x = AgeMale), fill = "green", bins = 20, alpha = 0.4) + geom_histogram(data = TBMU_divorce_outExpQ, aes(x = AgeFemale), bins = 20, alpha = 0.4)
```
```{r}
Age_graph
```
maybe group 5 and less and 20+?

```{r, include=FALSE}
Exp_graph = ggplot(data = TBMU_divorce_cleanQ, aes(x = ExpMale)) + geom_histogram(fill = "blue", bins = 15, alpha = 0.4) + geom_histogram(aes(x = ExpFemale), fill = "red", bins = 15, alpha = 0.4)
```
```{r}
Exp_graph
```
maybe group 15+?

```{r, include=FALSE}
Bond_graph = ggplot(data = TBMU_divorce_cleanQ, aes(x = PairBond)) + geom_histogram(fill = "blue", bins = 12, alpha = 0.4)
```
```{r}
Bond_graph
```
maybe group 6+?

sample size is quite small for the extreme values of ages, breeding experience and pair-bond, so I'll group them together.
to facilitate model convergence and allow a better comparison of effects across models, all the variables are standardised
I'm also creating variables to look at quadratic effects
```{r}
TBMU_divorce_cleanQ = TBMU_divorce_cleanQ %>% mutate_if(is.integer, as.numeric) %>% 
                            mutate(stdAgeMale = if_else(AgeMale >=20,20, if_else(AgeMale <= 5, 5, AgeMale)), stdAgeFemale = if_else(AgeFemale >= 20, 20, if_else(AgeFemale <= 5, 5, AgeFemale)), stdExpMale = if_else(ExpMale >= 15, 15, ExpMale), stdExpFemale = if_else(ExpFemale >= 15, 15, ExpFemale), stdPairBond = if_else(PairBond >= 6, 6, PairBond)) %>%
                         mutate(stdAgeMale = arm::rescale(stdAgeMale), stdAgeFemale = rescale(stdAgeFemale), stdExpMale = rescale(stdExpMale), stdExpFemale = rescale(stdExpFemale), stdPairBond = rescale(stdPairBond), stdQlty = rescale(QLTY), stdFledge = rescale(Fledge), stdLaying = rescale(Laying),stdYear = rescale(Year)) %>% mutate(stdAgeMaleSq = I(stdAgeMale^2), stdAgeFemaleSq = I(stdAgeFemale^2), stdExpMaleSq = I(stdExpMale^2), stdExpFemaleSq = I(stdExpFemale^2), stdPairBondSq = I(stdPairBond^2), stdQltySq = I(stdQlty^2), stdLayingSq = I(stdLaying^2), stdYearSq = I(stdYear^2))
```

```{r}
TBMU_divorce_outExpQ = TBMU_divorce_outExpQ %>% mutate_if(is.integer, as.numeric)%>% 
           mutate(stdAgeMale = if_else(AgeMale >=20,20, if_else(AgeMale <= 5, 5, AgeMale)), stdAgeFemale = if_else(AgeFemale >= 20, 20, if_else(AgeFemale <= 5, 5, AgeFemale))) %>%
             mutate(stdAgeMale = arm::rescale(stdAgeMale), stdAgeFemale = rescale(stdAgeFemale), stdQlty = rescale(QLTY), stdFledge = rescale(Fledge), stdLaying = rescale(Laying),stdYear = rescale(Year))%>%
        mutate(stdAgeMaleSq = I(stdAgeMale^2), stdAgeFemaleSq = I(stdAgeFemale^2), stdQltySq = I(stdQlty^2), stdLayingSq = I(stdLaying^2), stdYeaSq = I(stdYear^2))
```


I won't consider interactions with more than 2 terms and not models with age and breeding experience together
```{r}
mod_divQ = list()

## 2-way interactions with fledging probability
mod_divQ[[1]] = glmmTMB(ProbDiv ~ stdFledge * stdAgeMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data = TBMU_divorce_cleanQ)
mod_divQ[[2]] = glmmTMB(ProbDiv ~ stdFledge * stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[3]] = glmmTMB(ProbDiv ~ stdFledge * stdExpMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[4]] = glmmTMB(ProbDiv ~ stdFledge * stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[5]] = glmmTMB(ProbDiv ~ stdFledge * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[6]] = glmmTMB(ProbDiv ~ stdFledge * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[7]] = glmmTMB(ProbDiv ~ stdFledge * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with male age
mod_divQ[[8]] = glmmTMB(ProbDiv ~ stdAgeMale * stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[9]] = glmmTMB(ProbDiv ~ stdAgeMale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[10]] = glmmTMB(ProbDiv ~ stdAgeMale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[11]] = glmmTMB(ProbDiv ~ stdAgeMale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with female age
mod_divQ[[12]] = glmmTMB(ProbDiv ~ stdAgeFemale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[13]] = glmmTMB(ProbDiv ~ stdAgeFemale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[14]] = glmmTMB(ProbDiv ~ stdAgeFemale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interaction with male breeding experience
mod_divQ[[15]] = glmmTMB(ProbDiv ~ stdExpMale * stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[16]] = glmmTMB(ProbDiv ~ stdExpMale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[17]] = glmmTMB(ProbDiv ~ stdExpMale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[18]] = glmmTMB(ProbDiv ~ stdExpMale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with female breeding experience
mod_divQ[[19]] = glmmTMB(ProbDiv ~ stdExpFemale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[20]] = glmmTMB(ProbDiv ~ stdExpFemale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[21]] = glmmTMB(ProbDiv ~ stdExpFemale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with pair-bond duration
mod_divQ[[22]] = glmmTMB(ProbDiv ~ stdPairBond * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[23]] = glmmTMB(ProbDiv ~ stdPairBond * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with site quality
mod_divQ[[24]] = glmmTMB(ProbDiv ~ stdQlty * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with fledging probability
mod_divQ[[25]] = glmmTMB(ProbDiv ~ stdFledge + stdAgeMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[26]] = glmmTMB(ProbDiv ~ stdFledge + stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[27]] = glmmTMB(ProbDiv ~ stdFledge + stdExpMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[28]] = glmmTMB(ProbDiv ~ stdFledge + stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[29]] = glmmTMB(ProbDiv ~ stdFledge + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[30]] = glmmTMB(ProbDiv ~ stdFledge + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[31]] = glmmTMB(ProbDiv ~ stdFledge + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with male age
mod_divQ[[32]] = glmmTMB(ProbDiv ~ stdAgeMale + stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[33]] = glmmTMB(ProbDiv ~ stdAgeMale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[34]] = glmmTMB(ProbDiv ~ stdAgeMale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[35]] = glmmTMB(ProbDiv ~ stdAgeMale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with female age
mod_divQ[[36]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[37]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[38]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with male breeding experience
mod_divQ[[39]] = glmmTMB(ProbDiv ~ stdExpMale + stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[40]] = glmmTMB(ProbDiv ~ stdExpMale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[41]] = glmmTMB(ProbDiv ~ stdExpMale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[42]] = glmmTMB(ProbDiv ~ stdExpMale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", control = glmmTMBControl(optCtrl = list(iter.max = 1000, eval.max = 1000), profile = TRUE), data =  TBMU_divorce_cleanQ)

## additive models with female breeding experience
mod_divQ[[43]] = glmmTMB(ProbDiv ~ stdExpFemale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[44]] = glmmTMB(ProbDiv ~ stdExpFemale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[45]] = glmmTMB(ProbDiv ~ stdExpFemale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with pair-bond duration
mod_divQ[[46]] = glmmTMB(ProbDiv ~ stdPairBond + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[47]] = glmmTMB(ProbDiv ~ stdPairBond + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with site quality
mod_divQ[[48]] = glmmTMB(ProbDiv ~ stdQlty + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## models with quadratic effect
mod_divQ[[49]] = glmmTMB(ProbDiv ~ stdAgeMale + stdAgeMaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[50]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdAgeFemaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[51]] = glmmTMB(ProbDiv ~ stdExpMale + stdExpMaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[52]] = glmmTMB(ProbDiv ~ stdExpFemale + stdExpFemaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[53]] = glmmTMB(ProbDiv ~ stdQlty + stdQltySq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[54]] = glmmTMB(ProbDiv ~ stdPairBond + stdPairBondSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[55]] = glmmTMB(ProbDiv ~ stdLaying + stdLayingSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## single effects models
mod_divQ[[56]] = glmmTMB(ProbDiv ~ stdFledge + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[57]] = glmmTMB(ProbDiv ~ stdAgeMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[58]] = glmmTMB(ProbDiv ~ stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[59]] = glmmTMB(ProbDiv ~ stdExpMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", control = glmmTMBControl(optCtrl = list(iter.max = 1000, eval.max = 1000), profile = TRUE),data =  TBMU_divorce_cleanQ)
mod_divQ[[60]] = glmmTMB(ProbDiv ~ stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[61]] = glmmTMB(ProbDiv ~ stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[62]] = glmmTMB(ProbDiv ~ stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[63]] = glmmTMB(ProbDiv ~ stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

mod_divQ[[64]] = glmmTMB(ProbDiv ~ stdYear + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[65]] = glmmTMB(ProbDiv ~ stdYear + stdYearSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[66]] = glmmTMB(ProbDiv ~ 1 + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
```


Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_div = model.sel(mod_div, rank = "AICc")
modavg_divD6 = model.avg(AIC_div, beta = "none", subset = delta <= 6)
modavg_divP95 = model.avg(AIC_div, beta = "none", subset = cumsum(weight) <.95)
```

```{r include = FALSE}
mod_div_EstimatesD6 = cbind(summary(modavg_divD6)$coefmat.subset[,c(1,3)], confint(modavg_divD6))
mod_div_EstimatesP95 = cbind(summary(modavg_divP95)$coefmat.subset[,c(1,3)], confint(modavg_divP95))
```

```{r echo = FALSE}
mod_div_EstimatesD6
```
there's a negative effect of age and breeding experience of both sexes, and of reproductive success, while site quality and pair-bond also influenced the probability of divorce but to a lesser extent

```{r echo = FALSE}
mod_div_EstimatesP95
```
when considering the 95% of cumulative weights, the effects are the same but they are slightly weaker

```{r}
write.table(mod_div_EstimatesD6,"estimates_D6_divorce_TBMU.csv", row.names = TRUE, sep = ",")
write.table(mod_div_EstimatesP95,"estimates_P95_divorce_TBMU.csv", row.names = TRUE, sep = ",")
```

effect of breeding experience
```{r}
div_Exp = TBMU_divorce_cleanQ %>% mutate(ExpFemale = if_else(ExpFemale >= 15, 15, ExpFemale)) %>% group_by(ExpFemale) %>% summarise(PropDivFemale = mean(ProbDiv), SE_PropDivFemale = sd(ProbDiv)/sqrt(n()), N_Female = n()) %>% rename(Exp = ExpFemale)
div_ExpM = TBMU_divorce_cleanQ %>% mutate(ExpMale = if_else(ExpMale >= 15, 15, ExpMale)) %>% group_by(ExpMale) %>% summarise(PropDivMale = mean(ProbDiv), SE_PropDivMale = sd(ProbDiv)/sqrt(n()), N_Male = n()) %>% rename(Exp = ExpMale)
div_Exp = full_join(div_Exp, div_ExpM, by = "Exp")
```

```{r include=FALSE}
plot_div_Exp = ggplot(data = div_Exp, aes(x = Exp)) + geom_point(aes(y = PropDivFemale, size = N_Female), colour = "red") + geom_errorbar(aes(ymax = PropDivFemale + SE_PropDivFemale, ymin = PropDivFemale - SE_PropDivFemale), colour = "red") +
  geom_point(aes(y = PropDivMale, size = N_Male), colour = "blue") + geom_errorbar(aes(ymax = PropDivMale + SE_PropDivMale, ymin = PropDivMale - SE_PropDivMale), colour = "blue") + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Breeding experience (years)", y = "Probability of divorce") 
```
```{r echo = FALSE}
plot_div_Exp
```

effect of age
```{r}
div_Age = TBMU_divorce_cleanQ %>% mutate(AgeFemale = if_else(AgeFemale <=5, 5, if_else(AgeFemale >= 20, 20, AgeFemale))) %>% group_by(AgeFemale) %>% summarise(PropDivFemale = mean(ProbDiv), SE_PropDivFemale = sd(ProbDiv)/sqrt(n()), N_Female = n()) %>% rename(Age = AgeFemale)
div_AgeM = TBMU_divorce_cleanQ %>% mutate(AgeMale = if_else(AgeMale <= 5, 5, if_else(AgeMale >= 20, 20, AgeMale))) %>% group_by(AgeMale) %>% summarise(PropDivMale = mean(ProbDiv), SE_PropDivMale = sd(ProbDiv)/sqrt(n()), N_Male = n()) %>% rename(Age = AgeMale)
div_Age = full_join(div_Age, div_AgeM, by = "Age")
```

```{r include=FALSE}
plot_div_Age = ggplot(data = div_Age, aes(x = Age)) + geom_point(aes(y = PropDivFemale, size = N_Female), colour = "red") + geom_errorbar(aes(ymax = PropDivFemale + SE_PropDivFemale, ymin = PropDivFemale - SE_PropDivFemale), colour = "red") +
  geom_point(aes(y = PropDivMale, size = N_Male), colour = "blue") + geom_errorbar(aes(ymax = PropDivMale + SE_PropDivMale, ymin = PropDivMale - SE_PropDivMale), colour = "blue") + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Age (years)", y = "Probability of divorce") 
```
```{r echo = FALSE}
plot_div_Age
```

effect of reproductive success
```{r}
div_Fledge = TBMU_divorce_cleanQ %>% group_by(Fledge) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N = n())
```

```{r include=FALSE}
plot_div_Fledge = ggplot(data = div_Fledge, aes(x = factor(Fledge))) + geom_point(aes(y = PropDiv, size = N)) + geom_errorbar(aes(ymax = PropDiv + SE_PropDiv, ymin = PropDiv - SE_PropDiv), width = 0.2) + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Fledging success", y = "Probability of divorce") + scale_x_discrete(limits = c("0","1"),labels = c("NO","YES"))
```
```{r echo = FALSE}
plot_div_Fledge
```

effect of site quality
```{r}
div_Qlty = TBMU_divorce_cleanQ %>% group_by(QLTY) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N = n())
```

```{r include=FALSE}
plot_div_Qlty = ggplot(data = div_Qlty, aes(x = QLTY)) + geom_point(aes(y = PropDiv, size = N)) + geom_errorbar(aes(ymax = PropDiv + SE_PropDiv, ymin = PropDiv - SE_PropDiv), width = 0.2) + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Site quality", y = "Probability of divorce")
```
```{r echo = FALSE}
plot_div_Qlty
```