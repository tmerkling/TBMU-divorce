---
title: "Divorce_TBMU"
author: "Thomas Merkling"
date: "11 July 2018"
output: html_document
---

```{r, warning = FALSE, message = FALSE, include = FALSE}
setwd("D:/Thomas/Google Drive/postdoc/FQRNT_murre_project/murre_data/TBMU-divorce")
```

```{r}
library(dplyr)
library(glmmTMB)
library(MuMIn)
library(corrplot)
library(arm)
library(ggplot2)
```


# **1. Causes of divorce**

import data created with the master data
```{r}
TBMU_divorce = read.table("TBMU_Coats_divorce_data.csv", header = TRUE, sep = ",")
dim(TBMU_divorce) # 1460   18
```

for these analyses we are only interested in whether a pair remained together or divorced, so we'll discard all the mate switching due to an individual disappareance.
```{r}
TBMU_divorce = TBMU_divorce %>% filter(Outcome != "DEAD")
dim(TBMU_divorce) # 812  18
TBMU_divorce = TBMU_divorce %>% mutate(ProbDiv = if_else(Outcome == "DIV",1,0))
```

data exploration: how many missing data for each 
```{r }
table(is.na(TBMU_divorce$Laying))
table(is.na(TBMU_divorce$Fledge))
table(is.na(TBMU_divorce$AgeMale))
table(is.na(TBMU_divorce$AgeFemale))
table(is.na(TBMU_divorce$AgeBird1))
table(is.na(TBMU_divorce$AgeBird2))
table(is.na(TBMU_divorce$ExpMale))
table(is.na(TBMU_divorce$ExpFemale))
table(is.na(TBMU_divorce$ExpBird1))
table(is.na(TBMU_divorce$ExpBird2))
table(is.na(TBMU_divorce$PairBond))
table(is.na(TBMU_divorce$QLTY))
```
it's mostly for age and breeding experience that there are missing values and for fledging a bit too

Create a new variable for the study plot. Some experiments have been carried out on J and small sample size for N, so will not consider those 2.
```{r}
TBMU_divorce_clean = TBMU_divorce %>% dplyr::select(c(-Hatching,-Outcome)) %>% na.omit() %>% mutate(Plot = substr(Site,1,1)) %>% filter(Plot != "N" & Plot != "J")
TBMU_divorce_clean$BandNo1 = factor(TBMU_divorce_clean$BandNo1)
TBMU_divorce_clean$BandNo2 = factor(TBMU_divorce_clean$BandNo2)
TBMU_divorce_clean$Site = factor(TBMU_divorce_clean$Site)
```
removing all the observations with at least one NA leaves 320 observations!

```{r}
TBMU_divorce_outExp = TBMU_divorce %>% dplyr::select(c(-Hatching,-Outcome,-ExpMale,-ExpFemale,-ExpBird1,-ExpBird2,-PairBond)) %>% na.omit() %>% mutate(Plot = substr(Site,1,1))  %>% filter(Plot != "N" & Plot != "J")
```
if I include observations with unreliable info about breeding experience and pair-bond, it yields ~140 more observations (but can't have those variables in the models)

Is there variability among years and/or among plots in divorce rates?
```{r}
div_Year = TBMU_divorce_outExp %>% group_by(Year) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N_Year = n())
div_Plot = TBMU_divorce_outExp %>% group_by(Plot) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N_Plot = n())
```
```{r, include=FALSE}
Year_graph = ggplot(data = div_Year, aes(x = Year, y = PropDiv)) + geom_point(aes(size = N_Year)) + geom_errorbar(aes(ymin = PropDiv - SE_PropDiv, ymax = PropDiv + SE_PropDiv)) + theme_bw()
```
```{r}
Year_graph
```
divorce rates seem slightly lower in recent years...

```{r, include=FALSE}
Plot_graph = ggplot(data = div_Plot, aes(x = Plot, y = PropDiv)) + geom_point(aes(size = N_Plot)) + geom_errorbar(aes(ymin = PropDiv - SE_PropDiv, ymax = PropDiv + SE_PropDiv)) + theme_bw()
```
```{r}
Plot_graph
```
huge variation among plots, with much lower divorce rates and larger sample size in the Q plot. We know that data quality is much higher for the Q plot, and the observed average divorce rate is closer to what we'd expect, so probably better to focus only on Q plot...

```{r}
TBMU_divorce_cleanQ = TBMU_divorce_clean %>% filter(Plot == "Q")
TBMU_divorce_outExpQ = TBMU_divorce_outExp %>% filter(Plot == "Q")
```

collinearity among explanatory variables
```{r}
cor_div = cor(TBMU_divorce_cleanQ[,c(5,7:8,11:12,15:16)])
corrplot.mixed(cor_div, upper = "ellipse", lower = "number")
```
Logically age and experience are strongly correlated within a sex, but otherwise no very strong correlations. So age and experience will never be in the same model.
We also know that reproductive success varies with age in this species, so is there some collinearity with Fledge?

```{r}
source(file = "HighstatLib.R") 
```
this is an R code containing functions created by Zuur et al.

```{r}
corvif(TBMU_divorce_cleanQ[,c(5:8,15:16)])
```
VIFs suggest that there is no multicollinearity between ages, laying date, fledging probability, pair-bond and site quality

loooking at spread of data for ages, breeding experience and pair-bond to see if I need to group data
```{r, include=FALSE}
Age_graph = ggplot(data = TBMU_divorce_cleanQ, aes(x = AgeMale)) + geom_histogram(fill = "blue", bins = 20, alpha = 0.4) + geom_histogram(aes(x = AgeFemale), fill = "red", bins = 20, alpha = 0.4) + geom_histogram(data = TBMU_divorce_outExpQ, aes(x = AgeMale), fill = "green", bins = 20, alpha = 0.4) + geom_histogram(data = TBMU_divorce_outExpQ, aes(x = AgeFemale), bins = 20, alpha = 0.4)
```
```{r}
Age_graph
```
maybe group 5 and less and 20+?

```{r, include=FALSE}
Exp_graph = ggplot(data = TBMU_divorce_cleanQ, aes(x = ExpMale)) + geom_histogram(fill = "blue", bins = 15, alpha = 0.4) + geom_histogram(aes(x = ExpFemale), fill = "red", bins = 15, alpha = 0.4)
```
```{r}
Exp_graph
```
maybe group 15+?

```{r, include=FALSE}
Bond_graph = ggplot(data = TBMU_divorce_cleanQ, aes(x = PairBond)) + geom_histogram(fill = "blue", bins = 12, alpha = 0.4)
```
```{r}
Bond_graph
```
maybe group 6+?

sample size is quite small for the extreme values of ages, breeding experience and pair-bond, so I'll group them together.
to facilitate model convergence and allow a better comparison of effects across models, all the variables are standardised
I'm also creating variables to look at quadratic effects
```{r}
TBMU_divorce_cleanQ = TBMU_divorce_cleanQ %>% mutate_if(is.integer, as.numeric) %>% 
                            mutate(stdAgeMale = if_else(AgeMale >=20,20, if_else(AgeMale <= 5, 5, AgeMale)), stdAgeFemale = if_else(AgeFemale >= 20, 20, if_else(AgeFemale <= 5, 5, AgeFemale)), stdExpMale = if_else(ExpMale >= 15, 15, ExpMale), stdExpFemale = if_else(ExpFemale >= 15, 15, ExpFemale), stdPairBond = if_else(PairBond >= 6, 6, PairBond)) %>%
                         mutate(stdAgeMale = arm::rescale(stdAgeMale), stdAgeFemale = rescale(stdAgeFemale), stdExpMale = rescale(stdExpMale), stdExpFemale = rescale(stdExpFemale), stdPairBond = rescale(stdPairBond), stdQlty = rescale(QLTY), stdFledge = rescale(Fledge), stdLaying = rescale(Laying),stdYear = rescale(Year)) %>% mutate(stdAgeMaleSq = I(stdAgeMale^2), stdAgeFemaleSq = I(stdAgeFemale^2), stdExpMaleSq = I(stdExpMale^2), stdExpFemaleSq = I(stdExpFemale^2), stdPairBondSq = I(stdPairBond^2), stdQltySq = I(stdQlty^2), stdLayingSq = I(stdLaying^2), stdYearSq = I(stdYear^2))
```

```{r}
TBMU_divorce_outExpQ = TBMU_divorce_outExpQ %>% mutate_if(is.integer, as.numeric)%>% 
           mutate(stdAgeMale = if_else(AgeMale >=20,20, if_else(AgeMale <= 5, 5, AgeMale)), stdAgeFemale = if_else(AgeFemale >= 20, 20, if_else(AgeFemale <= 5, 5, AgeFemale))) %>%
             mutate(stdAgeMale = arm::rescale(stdAgeMale), stdAgeFemale = rescale(stdAgeFemale), stdQlty = rescale(QLTY), stdFledge = rescale(Fledge), stdLaying = rescale(Laying),stdYear = rescale(Year))%>%
        mutate(stdAgeMaleSq = I(stdAgeMale^2), stdAgeFemaleSq = I(stdAgeFemale^2), stdQltySq = I(stdQlty^2), stdLayingSq = I(stdLaying^2), stdYeaSq = I(stdYear^2))
```


I won't consider interactions with more than 2 terms and not models with age and breeding experience together
```{r}
mod_divQ = list()

## 2-way interactions with fledging probability
mod_divQ[[1]] = glmmTMB(ProbDiv ~ stdFledge * stdAgeMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data = TBMU_divorce_cleanQ)
mod_divQ[[2]] = glmmTMB(ProbDiv ~ stdFledge * stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[3]] = glmmTMB(ProbDiv ~ stdFledge * stdExpMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[4]] = glmmTMB(ProbDiv ~ stdFledge * stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[5]] = glmmTMB(ProbDiv ~ stdFledge * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[6]] = glmmTMB(ProbDiv ~ stdFledge * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[7]] = glmmTMB(ProbDiv ~ stdFledge * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with male age
mod_divQ[[8]] = glmmTMB(ProbDiv ~ stdAgeMale * stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[9]] = glmmTMB(ProbDiv ~ stdAgeMale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[10]] = glmmTMB(ProbDiv ~ stdAgeMale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[11]] = glmmTMB(ProbDiv ~ stdAgeMale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with female age
mod_divQ[[12]] = glmmTMB(ProbDiv ~ stdAgeFemale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[13]] = glmmTMB(ProbDiv ~ stdAgeFemale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[14]] = glmmTMB(ProbDiv ~ stdAgeFemale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interaction with male breeding experience
mod_divQ[[15]] = glmmTMB(ProbDiv ~ stdExpMale * stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[16]] = glmmTMB(ProbDiv ~ stdExpMale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[17]] = glmmTMB(ProbDiv ~ stdExpMale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[18]] = glmmTMB(ProbDiv ~ stdExpMale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with female breeding experience
mod_divQ[[19]] = glmmTMB(ProbDiv ~ stdExpFemale * stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[20]] = glmmTMB(ProbDiv ~ stdExpFemale * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[21]] = glmmTMB(ProbDiv ~ stdExpFemale * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with pair-bond duration
mod_divQ[[22]] = glmmTMB(ProbDiv ~ stdPairBond * stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[23]] = glmmTMB(ProbDiv ~ stdPairBond * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## 2-way interactions with site quality
mod_divQ[[24]] = glmmTMB(ProbDiv ~ stdQlty * stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with fledging probability
mod_divQ[[25]] = glmmTMB(ProbDiv ~ stdFledge + stdAgeMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[26]] = glmmTMB(ProbDiv ~ stdFledge + stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[27]] = glmmTMB(ProbDiv ~ stdFledge + stdExpMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[28]] = glmmTMB(ProbDiv ~ stdFledge + stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[29]] = glmmTMB(ProbDiv ~ stdFledge + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[30]] = glmmTMB(ProbDiv ~ stdFledge + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[31]] = glmmTMB(ProbDiv ~ stdFledge + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with male age
mod_divQ[[32]] = glmmTMB(ProbDiv ~ stdAgeMale + stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[33]] = glmmTMB(ProbDiv ~ stdAgeMale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[34]] = glmmTMB(ProbDiv ~ stdAgeMale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[35]] = glmmTMB(ProbDiv ~ stdAgeMale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with female age
mod_divQ[[36]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[37]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[38]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with male breeding experience
mod_divQ[[39]] = glmmTMB(ProbDiv ~ stdExpMale + stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[40]] = glmmTMB(ProbDiv ~ stdExpMale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[41]] = glmmTMB(ProbDiv ~ stdExpMale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[42]] = glmmTMB(ProbDiv ~ stdExpMale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", control = glmmTMBControl(optCtrl = list(iter.max = 1000, eval.max = 1000), profile = TRUE), data =  TBMU_divorce_cleanQ)

## additive models with female breeding experience
mod_divQ[[43]] = glmmTMB(ProbDiv ~ stdExpFemale + stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[44]] = glmmTMB(ProbDiv ~ stdExpFemale + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[45]] = glmmTMB(ProbDiv ~ stdExpFemale + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with pair-bond duration
mod_divQ[[46]] = glmmTMB(ProbDiv ~ stdPairBond + stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[47]] = glmmTMB(ProbDiv ~ stdPairBond + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## additive models with site quality
mod_divQ[[48]] = glmmTMB(ProbDiv ~ stdQlty + stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## models with quadratic effect
mod_divQ[[49]] = glmmTMB(ProbDiv ~ stdAgeMale + stdAgeMaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[50]] = glmmTMB(ProbDiv ~ stdAgeFemale + stdAgeFemaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[51]] = glmmTMB(ProbDiv ~ stdExpMale + stdExpMaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[52]] = glmmTMB(ProbDiv ~ stdExpFemale + stdExpFemaleSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[53]] = glmmTMB(ProbDiv ~ stdQlty + stdQltySq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[54]] = glmmTMB(ProbDiv ~ stdPairBond + stdPairBondSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[55]] = glmmTMB(ProbDiv ~ stdLaying + stdLayingSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

## single effects models
mod_divQ[[56]] = glmmTMB(ProbDiv ~ stdFledge + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[57]] = glmmTMB(ProbDiv ~ stdAgeMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[58]] = glmmTMB(ProbDiv ~ stdAgeFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[59]] = glmmTMB(ProbDiv ~ stdExpMale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", control = glmmTMBControl(optCtrl = list(iter.max = 1000, eval.max = 1000), profile = TRUE),data =  TBMU_divorce_cleanQ)
mod_divQ[[60]] = glmmTMB(ProbDiv ~ stdExpFemale + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[61]] = glmmTMB(ProbDiv ~ stdPairBond + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[62]] = glmmTMB(ProbDiv ~ stdQlty + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[63]] = glmmTMB(ProbDiv ~ stdLaying + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)

mod_divQ[[64]] = glmmTMB(ProbDiv ~ stdYear + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[65]] = glmmTMB(ProbDiv ~ stdYear + stdYearSq + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
mod_divQ[[66]] = glmmTMB(ProbDiv ~ 1 + (1|Year) + (1|Site) + (1|BandNo1) + (1|BandNo2), family = "binomial", data =  TBMU_divorce_cleanQ)
```


Check simulated residuals using DHARMa package?

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_div = model.sel(mod_div, rank = "AICc")
modavg_divD6 = model.avg(AIC_div, beta = "none", subset = delta <= 6)
modavg_divP95 = model.avg(AIC_div, beta = "none", subset = cumsum(weight) <.95)
```

```{r include = FALSE}
mod_div_EstimatesD6 = cbind(summary(modavg_divD6)$coefmat.subset[,c(1,3)], confint(modavg_divD6))
mod_div_EstimatesP95 = cbind(summary(modavg_divP95)$coefmat.subset[,c(1,3)], confint(modavg_divP95))
```

```{r echo = FALSE}
mod_div_EstimatesD6
```
there's a negative effect of age and breeding experience of both sexes, and of reproductive success, while site quality and pair-bond also influenced the probability of divorce but to a lesser extent

```{r echo = FALSE}
mod_div_EstimatesP95
```
when considering the 95% of cumulative weights, the effects are the same but they are slightly weaker

```{r}
write.table(mod_div_EstimatesD6,"estimates_D6_divorce_TBMU.csv", row.names = TRUE, sep = ",")
write.table(mod_div_EstimatesP95,"estimates_P95_divorce_TBMU.csv", row.names = TRUE, sep = ",")
```


effect of breeding experience
```{r}
div_Exp = TBMU_divorce_cleanQ %>% mutate(ExpFemale = if_else(ExpFemale >= 15, 15, ExpFemale)) %>% group_by(ExpFemale) %>% summarise(PropDivFemale = mean(ProbDiv), SE_PropDivFemale = sd(ProbDiv)/sqrt(n()), N_Female = n()) %>% rename(Exp = ExpFemale)
div_ExpM = TBMU_divorce_cleanQ %>% mutate(ExpMale = if_else(ExpMale >= 15, 15, ExpMale)) %>% group_by(ExpMale) %>% summarise(PropDivMale = mean(ProbDiv), SE_PropDivMale = sd(ProbDiv)/sqrt(n()), N_Male = n()) %>% rename(Exp = ExpMale)
div_Exp = full_join(div_Exp, div_ExpM, by = "Exp")
```

```{r include=FALSE}
plot_div_Exp = ggplot(data = div_Exp, aes(x = Exp)) + geom_point(aes(y = PropDivFemale, size = N_Female), colour = "red") + geom_errorbar(aes(ymax = PropDivFemale + SE_PropDivFemale, ymin = PropDivFemale - SE_PropDivFemale), colour = "red") +
  geom_point(aes(y = PropDivMale, size = N_Male), colour = "blue") + geom_errorbar(aes(ymax = PropDivMale + SE_PropDivMale, ymin = PropDivMale - SE_PropDivMale), colour = "blue") + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Breeding experience (years)", y = "Probability of divorce") 
```
```{r echo = FALSE}
plot_div_Exp
```

effect of age
```{r}
div_Age = TBMU_divorce_cleanQ %>% mutate(AgeFemale = if_else(AgeFemale <=5, 5, if_else(AgeFemale >= 20, 20, AgeFemale))) %>% group_by(AgeFemale) %>% summarise(PropDivFemale = mean(ProbDiv), SE_PropDivFemale = sd(ProbDiv)/sqrt(n()), N_Female = n()) %>% rename(Age = AgeFemale)
div_AgeM = TBMU_divorce_cleanQ %>% mutate(AgeMale = if_else(AgeMale <= 5, 5, if_else(AgeMale >= 20, 20, AgeMale))) %>% group_by(AgeMale) %>% summarise(PropDivMale = mean(ProbDiv), SE_PropDivMale = sd(ProbDiv)/sqrt(n()), N_Male = n()) %>% rename(Age = AgeMale)
div_Age = full_join(div_Age, div_AgeM, by = "Age")
```

```{r include=FALSE}
plot_div_Age = ggplot(data = div_Age, aes(x = Age)) + geom_point(aes(y = PropDivFemale, size = N_Female), colour = "red") + geom_errorbar(aes(ymax = PropDivFemale + SE_PropDivFemale, ymin = PropDivFemale - SE_PropDivFemale), colour = "red") +
  geom_point(aes(y = PropDivMale, size = N_Male), colour = "blue") + geom_errorbar(aes(ymax = PropDivMale + SE_PropDivMale, ymin = PropDivMale - SE_PropDivMale), colour = "blue") + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Age (years)", y = "Probability of divorce") 
```
```{r echo = FALSE}
plot_div_Age
```

because the effect of age is the same for both sex, I want to represent the combined effect ...
```{r}
TBMU_divorce_ageM = TBMU_divorce_cleanQ %>% dplyr::select (Site, Year, BandNo1, AgeMale, ProbDiv) %>% transmute(Site, Year, Band = BandNo1, Age = AgeMale, ProbDiv)
TBMU_divorce_ageF = TBMU_divorce_cleanQ %>% dplyr::select (Site, Year, BandNo2, AgeFemale, ProbDiv) %>% transmute(Site, Year, Band = BandNo2, Age = AgeFemale, ProbDiv)
TBMU_divorce_age = bind_rows(TBMU_divorce_ageF, TBMU_divorce_ageM)
TBMU_divorce_age$Site = factor(TBMU_divorce_age$Site)
TBMU_divorce_age$Band = factor(TBMU_divorce_age$Band)
```

had some issue with the predicted values when including random effects so used a glm but should fix this problem for publication!!
```{r}
mod_Age = glm(ProbDiv ~ Age, family = "binomial", data =  TBMU_divorce_age)
```

```{r}
dat_Age = data.frame(Age = seq(5,20, by = 1))
pred_Age = predict(mod_Age, dat_Age, se.fit = TRUE, type = "response")
dat_Age$fit = pred_Age$fit
dat_Age$se.fit = pred_Age$se.fit
```

```{r}
div_tot_Age = TBMU_divorce_age %>% mutate(Age = if_else(as.numeric(Age) <=5, 5, if_else(as.numeric(Age) >= 20, 20, as.numeric(Age)))) %>% group_by(Age) %>% summarise(mean_PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N = n())
```


```{r include=FALSE}
plot_div_tot_Age = ggplot(data = div_tot_Age, aes(x = Age)) + geom_point(aes(y = mean_PropDiv, size = N)) + geom_errorbar(aes(ymax = mean_PropDiv + SE_PropDiv, ymin = mean_PropDiv - SE_PropDiv))  + geom_line(data = dat_Age, aes(y = fit, x = Age), size = 2) + geom_line(data = dat_Age, aes(y = fit - se.fit, x = Age), lty =2) + geom_line(data = dat_Age, aes(y = fit + se.fit, x =  Age), lty = 2) +
  theme_bw() + 
  theme(axis.text = element_text(size = 50), axis.title = element_text(size = 50), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Age (years)", y = "Probability of divorce") 
```
```{r echo = FALSE}
png("Divorce ~ Age.png", width = 1600, height = 960, units = "px")

plot_div_tot_Age
dev.off()
```



effect of reproductive success
```{r}
div_Fledge = TBMU_divorce_cleanQ %>% group_by(Fledge) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N = n())
```

```{r include=FALSE}
plot_div_Fledge = ggplot(data = div_Fledge, aes(x = factor(Fledge))) + geom_point(aes(y = PropDiv), size = 20) + geom_errorbar(aes(ymax = PropDiv + SE_PropDiv, ymin = PropDiv - SE_PropDiv), width = 0.2) + theme_bw() + 
  theme(axis.text = element_text(size = 50), axis.title = element_text(size = 50), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Fledging success", y = "Probability of divorce") + scale_x_discrete(limits = c("0","1"),labels = c("NO","YES")) + annotate("text", x = 1, y = 0.15, label = 'N = 54', size = 20) + annotate("text", x = 2, y = 0.13, label = 'N = 169', size = 20)
```
```{r echo = FALSE}
png("Divorce ~ Fledge.png", width = 960, height = 960, units = "px")

plot_div_Fledge
dev.off()
```

effect of site quality
```{r}
div_Qlty = TBMU_divorce_cleanQ %>% group_by(QLTY) %>% summarise(PropDiv = mean(ProbDiv), SE_PropDiv = sd(ProbDiv)/sqrt(n()), N = n())
```

```{r include=FALSE}
plot_div_Qlty = ggplot(data = div_Qlty, aes(x = QLTY)) + geom_point(aes(y = PropDiv, size = N)) + geom_errorbar(aes(ymax = PropDiv + SE_PropDiv, ymin = PropDiv - SE_PropDiv), width = 0.2) + theme_bw() + 
  theme(axis.text = element_text(size = 15), axis.title = element_text(size = 17), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Site quality", y = "Probability of divorce")
```
```{r echo = FALSE}
plot_div_Qlty
```


side analysis
does the probability of fledging success increase with pair-bond duration?
```{r}
fledge_pairBond = TBMU_divorce_cleanQ %>% mutate(PairBond = ifelse(PairBond >= 4, 4, PairBond)) %>% group_by(PairBond,ProbDiv) %>% summarise(ProbFledge = mean(Fledge), SE_ProbFledge = sd(Fledge)/sqrt(n()), N_ProbFledge = n())
fledge_pairBond$Divorce = as.factor(fledge_pairBond$ProbDiv)
```

```{r}
plot_fledge_pairBond = ggplot(data = fledge_pairBond, aes(x = PairBond, y = ProbFledge)) + geom_point(aes( fill = Divorce), size = 15, shape = 21) + geom_errorbar(aes(ymin = ProbFledge - SE_ProbFledge, ymax = ProbFledge + SE_ProbFledge), width = 0.2) + theme_bw() + 
  theme(axis.text = element_text(size = 50), axis.title = element_text(size = 50), legend.position = c(0.04,0.10),panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(x = "Pair-bond duration (years)", y = "Probability of fledging")
```

```{r}
png("Fledge ~ PairBond.png", width = 1600, height = 960, units = "px")

plot_fledge_pairBond
dev.off()
```



# **2. Outcomes of divorce**

## **a. Within-bird comparison before/after divorce**

```{r}
prepost_comp = read.table("prepost_div_comp_TBMU.csv", header = TRUE, sep = ",")
```

```{r}
prepost_comp$Band = factor(prepost_comp$Band)
```
only a few individuals appear twice in the data, so probably no need to include a random effect for ID

what is the range of age and breeding experience?
```{r, include = FALSE}
with(prepost_comp, hist(Age, breaks = 22))
```
only very few observations after 12 years...

```{r}
with(prepost_comp, hist(Exp, breaks = 10))
```
only very few observations after 6 years...

grouping extreme ages and breeding experiences
```{r}
prepost_comp = prepost_comp %>% mutate_if(is.integer, as.numeric) %>% mutate(Age = if_else(Age >= 12, 12, Age), Exp = if_else(Exp >= 6, 6, Exp))
```

Will look into the effect of age, breeding experience and sex of a focal bird on the difference between its old and new mate. As there are different missing values for the different response variables, I'll create a new subset for each analyses.

### Age difference

```{r}
age_prepost_comp = prepost_comp %>% dplyr::select(Band, Year, Band, Sex, Age, Exp, AgeDiff) %>% filter(!is.na(AgeDiff))
```

standardisation of the explanatory variables
```{r}
age_prepost_comp = age_prepost_comp %>% mutate(stdAge = rescale(Age), stdExp = rescale(Exp), stdSex = rescale(Sex))
```

how does the distribution of age difference look like
```{r}
with(age_prepost_comp, hist(AgeDiff, breaks = 20))
```
Not great ... will see how the residuals look like...

```{r}
mod_AgeDiff = list()

mod_AgeDiff[[1]] = glmmTMB(AgeDiff ~ stdSex * stdAge + (1|Year), family = "gaussian", data = age_prepost_comp)
mod_AgeDiff[[2]] = glmmTMB(AgeDiff ~ stdSex * stdExp + (1|Year), family = "gaussian", data = age_prepost_comp)

mod_AgeDiff[[3]] = glmmTMB(AgeDiff ~ stdSex + stdAge + (1|Year), family = "gaussian", data = age_prepost_comp)
mod_AgeDiff[[4]] = glmmTMB(AgeDiff ~ stdSex + stdExp + (1|Year), family = "gaussian", data = age_prepost_comp)

mod_AgeDiff[[5]] = glmmTMB(AgeDiff ~ stdSex + (1|Year), family = "gaussian", data = age_prepost_comp)
mod_AgeDiff[[6]] = glmmTMB(AgeDiff ~ stdAge + (1|Year), family = "gaussian", data = age_prepost_comp)
mod_AgeDiff[[7]] = glmmTMB(AgeDiff ~ stdExp + (1|Year), family = "gaussian", data = age_prepost_comp)
mod_AgeDiff[[8]] = glmmTMB(AgeDiff ~ 1 + (1|Year), family = "gaussian", data = age_prepost_comp)
```

```{r}
hist(residuals(mod_AgeDiff[[8]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_AgeDiff = model.sel(mod_AgeDiff, rank = "AICc")
modavg_AgeDiffD6 = model.avg(mod_AgeDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
mod_AgeDiff_EstimatesD6 = cbind(summary(modavg_AgeDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_AgeDiffD6))
```
```{r}
mod_AgeDiff_EstimatesD6
```
No efffect of any explanatory covariables. The intercept is weakly positive suggesting that birds tend to repair with an older bird...

```{r}
write.table(mod_AgeDiff_EstimatesD6, "estimates_D6_AgeDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Breeding experience difference

```{r}
exp_prepost_comp = prepost_comp %>% dplyr::select(Band, Year, Band, Sex, Age, Exp, ExpDiff) %>% filter(!is.na(ExpDiff))
```

standardisation of the explanatory variables
```{r}
exp_prepost_comp = exp_prepost_comp %>% mutate(stdAge = rescale(Age), stdExp = rescale(Exp), stdSex = rescale(Sex))
```

how does the distribution of exp difference look like
```{r}
with(exp_prepost_comp, hist(ExpDiff, breaks = 20))
```
Not great ... will see how the residuals look like...

```{r}
mod_ExpDiff = list()

mod_ExpDiff[[1]] = glmmTMB(ExpDiff ~ stdSex * stdAge + (1|Year), family = "gaussian", data = exp_prepost_comp)
mod_ExpDiff[[2]] = glmmTMB(ExpDiff ~ stdSex * stdExp + (1|Year), family = "gaussian", data = exp_prepost_comp)

mod_ExpDiff[[3]] = glmmTMB(ExpDiff ~ stdSex + stdAge + (1|Year), family = "gaussian", data = exp_prepost_comp)
mod_ExpDiff[[4]] = glmmTMB(ExpDiff ~ stdSex + stdExp + (1|Year), family = "gaussian", data = exp_prepost_comp)

mod_ExpDiff[[5]] = glmmTMB(ExpDiff ~ stdSex + (1|Year), family = "gaussian", data = exp_prepost_comp)
mod_ExpDiff[[6]] = glmmTMB(ExpDiff ~ stdAge + (1|Year), family = "gaussian", data = exp_prepost_comp)
mod_ExpDiff[[7]] = glmmTMB(ExpDiff ~ stdExp + (1|Year), family = "gaussian", data = exp_prepost_comp)
mod_ExpDiff[[8]] = glmmTMB(ExpDiff ~ 1 + (1|Year), family = "gaussian", data = exp_prepost_comp)
```

```{r}
hist(residuals(mod_ExpDiff[[8]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_ExpDiff = model.sel(mod_ExpDiff, rank = "AICc")
modavg_ExpDiffD6 = model.avg(mod_ExpDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
mod_ExpDiff_EstimatesD6 = cbind(summary(modavg_ExpDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_ExpDiffD6))
```
```{r}
mod_ExpDiff_EstimatesD6
```
No efffect of any explanatory covariables. The intercept isn't really different from zero ...

```{r}
write.table(mod_ExpDiff_EstimatesD6, "estimates_D6_ExpDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Site quality difference

```{r}
qlty_prepost_comp = prepost_comp %>% dplyr::select(Band, Year, Band, Sex, Age, Exp, QltyDiff) %>% filter(!is.na(QltyDiff))
```

standardisation of the explanatory variables
```{r}
qlty_prepost_comp = qlty_prepost_comp %>% mutate(stdAge = rescale(Age), stdExp = rescale(Exp), stdSex = rescale(Sex))
```

how does the distribution of qlty difference look like
```{r}
with(qlty_prepost_comp, hist(QltyDiff, breaks = 20))
```
Not great ... will see how the residuals look like...

```{r}
mod_QltyDiff = list()

mod_QltyDiff[[1]] = glmmTMB(QltyDiff ~ stdSex * stdAge + (1|Year), family = "gaussian", data = qlty_prepost_comp)
mod_QltyDiff[[2]] = glmmTMB(QltyDiff ~ stdSex * stdExp + (1|Year), family = "gaussian", data = qlty_prepost_comp)

mod_QltyDiff[[3]] = glmmTMB(QltyDiff ~ stdSex + stdAge + (1|Year), family = "gaussian", data = qlty_prepost_comp)
mod_QltyDiff[[4]] = glmmTMB(QltyDiff ~ stdSex + stdExp + (1|Year), family = "gaussian", data = qlty_prepost_comp)

mod_QltyDiff[[5]] = glmmTMB(QltyDiff ~ stdSex + (1|Year), family = "gaussian", data = qlty_prepost_comp)
mod_QltyDiff[[6]] = glmmTMB(QltyDiff ~ stdAge + (1|Year), family = "gaussian", data = qlty_prepost_comp)
mod_QltyDiff[[7]] = glmmTMB(QltyDiff ~ stdExp + (1|Year), family = "gaussian", data = qlty_prepost_comp)
mod_QltyDiff[[8]] = glmmTMB(QltyDiff ~ 1 + (1|Year), family = "gaussian", data = qlty_prepost_comp)
```

```{r}
hist(residuals(mod_QltyDiff[[8]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_QltyDiff = model.sel(mod_QltyDiff, rank = "AICc")
modavg_QltyDiffD6 = model.avg(mod_QltyDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
mod_QltyDiff_EstimatesD6 = cbind(summary(modavg_QltyDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_QltyDiffD6))
```
```{r}
mod_QltyDiff_EstimatesD6
```
No efffect of any explanatory covariables. The intercept isn't different from zero ...

```{r}
write.table(mod_QltyDiff_EstimatesD6, "estimates_D6_QltyDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Laying date difference

```{r}
lay_prepost_comp = prepost_comp %>% dplyr::select(Band, Year, Band, Sex, Age, Exp, LayingDiff) %>% filter(!is.na(LayingDiff))
```

standardisation of the explanatory variables
```{r}
lay_prepost_comp = lay_prepost_comp %>% mutate(stdAge = rescale(Age), stdExp = rescale(Exp), stdSex = rescale(Sex))
```

how does the distribution of lay difference look like
```{r}
with(lay_prepost_comp, hist(LayingDiff, breaks = 20))
```
Not great ... looks skewed towards negative values slightly

```{r}
mod_LayDiff = list()

mod_LayDiff[[1]] = glmmTMB(LayingDiff ~ stdSex * stdAge + (1|Year), family = "gaussian", data = lay_prepost_comp)
mod_LayDiff[[2]] = glmmTMB(LayingDiff ~ stdSex * stdExp + (1|Year), family = "gaussian", data = lay_prepost_comp)

mod_LayDiff[[3]] = glmmTMB(LayingDiff ~ stdSex + stdAge + (1|Year), family = "gaussian", data = lay_prepost_comp)
mod_LayDiff[[4]] = glmmTMB(LayingDiff ~ stdSex + stdExp + (1|Year), family = "gaussian", data = lay_prepost_comp)

mod_LayDiff[[5]] = glmmTMB(LayingDiff ~ stdSex + (1|Year), family = "gaussian", data = lay_prepost_comp)
mod_LayDiff[[6]] = glmmTMB(LayingDiff ~ stdAge + (1|Year), family = "gaussian", data = lay_prepost_comp)
mod_LayDiff[[7]] = glmmTMB(LayingDiff ~ stdExp + (1|Year), family = "gaussian", data = lay_prepost_comp)
mod_LayDiff[[8]] = glmmTMB(LayingDiff ~ 1 + (1|Year), family = "gaussian", data = lay_prepost_comp)
```

```{r}
hist(residuals(mod_LayDiff[[8]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_LayDiff = model.sel(mod_LayDiff, rank = "AICc")
modavg_LayDiffD6 = model.avg(mod_LayDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
mod_LayDiff_EstimatesD6 = cbind(summary(modavg_LayDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_LayDiffD6))
```
```{r}
mod_LayDiff_EstimatesD6
```
No efffect of any explanatory covariables. The intercept isn't different from zero ...

```{r}
write.table(mod_LayDiff_EstimatesD6, "estimates_D6_LayDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Reprod success difference

```{r}
fledge_prepost_comp = prepost_comp %>% dplyr::select(Band, Year, Band, Sex, Age, Exp, FledgeDiff) %>% filter(!is.na(FledgeDiff))
```

standardisation of the explanatory variables and recoding of response variable
```{r}
fledge_prepost_comp = fledge_prepost_comp %>% mutate(stdAge = rescale(Age), stdExp = rescale(Exp), stdSex = rescale(Sex), FledgeDiff = if_else(FledgeDiff == -1, 0, if_else(FledgeDiff == 0, 0.5, 1)))
```

```{r}
FledgeWeights = rep(2, nrow(fledge_prepost_comp))
```


```{r}
mod_FledgeDiff = list()

mod_FledgeDiff[[1]] = glmmTMB(FledgeDiff ~ stdSex * stdAge + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)
mod_FledgeDiff[[2]] = glmmTMB(FledgeDiff ~ stdSex * stdExp + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)

mod_FledgeDiff[[3]] = glmmTMB(FledgeDiff ~ stdSex + stdAge + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)
mod_FledgeDiff[[4]] = glmmTMB(FledgeDiff ~ stdSex + stdExp + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)

mod_FledgeDiff[[5]] = glmmTMB(FledgeDiff ~ stdSex + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)
mod_FledgeDiff[[6]] = glmmTMB(FledgeDiff ~ stdAge + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)
mod_FledgeDiff[[7]] = glmmTMB(FledgeDiff ~ stdExp + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)
mod_FledgeDiff[[8]] = glmmTMB(FledgeDiff ~ 1 + (1|Year), weights = FledgeWeights, family = "binomial", data = fledge_prepost_comp)
```

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
AIC_FledgeDiff = model.sel(mod_FledgeDiff, rank = "AICc")
modavg_FledgeDiffD6 = model.avg(mod_FledgeDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
mod_FledgeDiff_EstimatesD6 = cbind(summary(modavg_FledgeDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_FledgeDiffD6))
```
```{r}
mod_FledgeDiff_EstimatesD6
```
No efffect of any explanatory covariables. The intercept isn't different from zero ...

```{r}
write.table(mod_FledgeDiff_EstimatesD6, "estimates_D6_FledgeDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


combine all the intercepts of all the analyses to compare the different variables
```{r}
all_prepost_comp = data.frame(Response = c("Age","Breeding experience","Site quality","Laying date","Fledging success"), Intercept = rep(0,5), SE = rep(0,5))
all_prepost_comp[1,c(2:3)] = mod_AgeDiff_EstimatesD6[1,c(1:2)]
all_prepost_comp[2,c(2:3)] = mod_ExpDiff_EstimatesD6[1,c(1:2)]
all_prepost_comp[3,c(2:3)] = mod_QltyDiff_EstimatesD6[1,c(1:2)]
all_prepost_comp[4,c(2:3)] = mod_LayDiff_EstimatesD6[1,c(1:2)]
all_prepost_comp[5,c(2:3)] = mod_FledgeDiff_EstimatesD6[1,c(1:2)]
```

```{r}
plot_comp = ggplot(data = all_prepost_comp, aes(y = Intercept, x = Response)) + geom_point(size = 15) + geom_errorbar(aes(ymax = Intercept + SE, ymin = Intercept - SE), width = 0.2) + theme_bw() + 
  theme(axis.text = element_text(size = 50), axis.title = element_text(size = 50), legend.position = "none",panel.grid.major=element_blank(), panel.grid.minor=element_blank()) + labs(y = "Difference between new and old (divorced) mate", x = "Variable") + geom_hline(yintercept = 0, linetype = 2)  + coord_flip()
```

```{r}
png("Difference between new and old mate.png", width = 1600, height = 960, units = "px")

plot_comp
dev.off()
```


## **b. Cost of partner change: comparison divorced and widowed birds**

```{r}
widow_comp = read.table("widow_indiv_TBMU.csv", header = TRUE, sep = ",")
```

```{r}
widow_comp$Band = factor(widow_comp$Band)
widow_comp$Status = "WIDOWED"
widow_comp = widow_comp[,c(1:6, 12:18)]
```

need to combine it with the divorce data.
```{r}
div_comp = read.table("prepost_div_comp_TBMU.csv", header = TRUE, sep = ",")
```

```{r}
div_comp$Band = factor(div_comp$Band)
div_comp$Status = "DIVORCED"
div_comp = div_comp[,c(1:6, 12:18)]
```

```{r}
widow_div_comp = bind_rows(div_comp,widow_comp) %>% mutate_if(is.character, as.factor)
```

inspect variation in differences between new and old mates
```{r}
hist(widow_div_comp$AgeDiff, breaks = 30)
```
```{r}
hist(widow_div_comp$ExpDiff, breaks = 30)
```
one extreme positive value!

```{r}
hist(widow_div_comp$QltyDiff, breaks = 20)
```
most individuals did not change

```{r}
hist(widow_div_comp$LayingDiff, breaks = 30)
```
```{r}
hist(widow_div_comp$FledgeDiff)
```

Will need to have Year, Band and Site as random effects

Goal is to look at whether there is a difference between divorced birds and widowed concerning who they remate with and whether it is sex-specific

### Age difference

```{r}
age_widiv_comp = widow_div_comp %>% dplyr::select(Band, Year, Site, Sex, Age, AgeDiff, Status) %>% filter(!is.na(AgeDiff))
```

standardisation of the explanatory variables
```{r}
library(arm)
age_widiv_comp = age_widiv_comp %>% mutate(stdSex = rescale(Sex), stdStatus = rescale(Status))
```

how does the distribution of age difference look like
```{r}
with(age_widiv_comp, hist(AgeDiff, breaks = 20))
```
Will have to be careful about the extreme positive age differences

Having Year, Site and Band as random effects caused some convergence issues, so I don't consider Site as it has a variance almost equal to zero.
```{r}
widiv_AgeDiff = list()

library(glmmTMB)
widiv_AgeDiff[[1]] = glmmTMB(AgeDiff ~ stdSex * stdStatus + (1|Year) + (1|Band), family = "gaussian", data = age_widiv_comp)
widiv_AgeDiff[[2]] = glmmTMB(AgeDiff ~ stdSex + stdStatus + (1|Year) + (1|Band), family = "gaussian", data = age_widiv_comp)
widiv_AgeDiff[[3]] = glmmTMB(AgeDiff ~ stdSex +  (1|Year) + (1|Band), family = "gaussian", data = age_widiv_comp)
widiv_AgeDiff[[4]] = glmmTMB(AgeDiff ~ stdStatus +  (1|Year) + (1|Band), family = "gaussian", data = age_widiv_comp)
widiv_AgeDiff[[5]] = glmmTMB(AgeDiff ~ 1 + (1|Year) +  (1|Band), family = "gaussian", data = age_widiv_comp)
```

```{r}
hist(residuals(widiv_AgeDiff[[1]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
library(MuMIn)
AIC_widiv_AgeDiff = model.sel(widiv_AgeDiff, rank = "AICc")
modavg_widiv_AgeDiffD6 = model.avg(widiv_AgeDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
widiv_AgeDiff_EstimatesD6 = cbind(summary(modavg_widiv_AgeDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_widiv_AgeDiffD6))
```
```{r}
widiv_AgeDiff_EstimatesD6
```
Negative effect of status! Widowed birds remate with younger birds than their previous partner as compared to divorced birds, probably because they are older...

```{r}
boxplot(Age ~ Status, data = age_widiv_comp)
```
Indeed, widowing happens later in life.

```{r}
write.table(widiv_AgeDiff_EstimatesD6, "estimates_D6_widiv_AgeDiff_TBMU.csv",row.names = TRUE, sep = ",")
```



### Breeding experience difference

```{r}
exp_widiv_comp = widow_div_comp %>% dplyr::select(Band, Year, Site, Sex, Exp, ExpDiff, Status) %>% filter(!is.na(ExpDiff))
```

standardisation of the explanatory variables
```{r}
library(arm)
exp_widiv_comp = exp_widiv_comp %>% mutate(stdSex = rescale(Sex), stdStatus = rescale(Status))
```

how does the distribution of age difference look like
```{r}
with(exp_widiv_comp, hist(ExpDiff, breaks = 20))
```
only a few large positive differences

Having Year, Site and Band as random effects caused some convergence issues, so I don't consider Site as it has a variance almost equal to zero.
```{r}
widiv_ExpDiff = list()

library(glmmTMB)
widiv_ExpDiff[[1]] = glmmTMB(ExpDiff ~ stdSex * stdStatus + (1|Year) + (1|Band), family = "gaussian", data = exp_widiv_comp)
widiv_ExpDiff[[2]] = glmmTMB(ExpDiff ~ stdSex + stdStatus + (1|Year) + (1|Band), family = "gaussian", data = exp_widiv_comp)
widiv_ExpDiff[[3]] = glmmTMB(ExpDiff ~ stdSex +  (1|Year) + (1|Band), family = "gaussian", data = exp_widiv_comp)
widiv_ExpDiff[[4]] = glmmTMB(ExpDiff ~ stdStatus +  (1|Year) + (1|Band), family = "gaussian", data = exp_widiv_comp)
widiv_ExpDiff[[5]] = glmmTMB(ExpDiff ~ 1 + (1|Year) +  (1|Band), family = "gaussian", data = exp_widiv_comp)
```

```{r}
hist(residuals(widiv_ExpDiff[[1]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
library(MuMIn)
AIC_widiv_ExpDiff = model.sel(widiv_ExpDiff, rank = "AICc")
modavg_widiv_ExpDiffD6 = model.avg(widiv_ExpDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
widiv_ExpDiff_EstimatesD6 = cbind(summary(modavg_widiv_ExpDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_widiv_ExpDiffD6))
```
```{r}
widiv_ExpDiff_EstimatesD6
```
No effect of any of the considered variables

```{r}
write.table(widiv_ExpDiff_EstimatesD6, "estimates_D6_widiv_ExpDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Site quality difference

First looking at whether birds moved or not depends on sex and status and then focusing on those who moved

```{r}
qlty_widiv_comp = widow_div_comp %>% dplyr::select(Band, Year, Site, Sex, QltyDiff, Moved, Status) %>% filter(!is.na(QltyDiff))
```

standardisation of the explanatory variables
```{r}
library(arm)
qlty_widiv_comp = qlty_widiv_comp %>% mutate(stdSex = rescale(Sex), stdStatus = rescale(Status), binMoved = if_else(Moved == "YES", 1, 0))
```

did individual move more after divorce?
```{r}
with(qlty_widiv_comp, table(Moved, Status))
```
YES! Probability of moving much higher after divorce than after widowing

```{r}
widiv_Moved = list()

library(glmmTMB)
widiv_Moved[[1]] = glmmTMB(binMoved ~ stdSex * stdStatus + (1|Year) + (1|Band) + (1|Site), family = "binomial", data = qlty_widiv_comp)
widiv_Moved[[2]] = glmmTMB(binMoved ~ stdSex + stdStatus + (1|Year) + (1|Band) + (1|Site), family = "binomial", data = qlty_widiv_comp)
widiv_Moved[[3]] = glmmTMB(binMoved ~ stdSex +  (1|Year) + (1|Band) + (1|Site), family = "binomial", data = qlty_widiv_comp)
widiv_Moved[[4]] = glmmTMB(binMoved ~ stdStatus +  (1|Year) + (1|Band) + (1|Site), family = "binomial", data = qlty_widiv_comp)
widiv_Moved[[5]] = glmmTMB(binMoved ~ 1 + (1|Year) +  (1|Band) + (1|Site), family = "binomial", data = qlty_widiv_comp)
```

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
library(MuMIn)
AIC_widiv_Moved = model.sel(widiv_Moved, rank = "AICc")
modavg_widiv_MovedD6 = model.avg(widiv_Moved, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
widiv_Moved_EstimatesD6 = cbind(summary(modavg_widiv_MovedD6)$coefmat.subset[,c(1,3)], confint(modavg_widiv_MovedD6))
```
```{r}
widiv_Moved_EstimatesD6
```
Negative effect of status: probability of moving lower for widowed birds

```{r}
write.table(widiv_Moved_EstimatesD6, "estimates_D6_widiv_Moved_TBMU.csv",row.names = TRUE, sep = ",")
```

Now focusing only on birds that moved
```{r}
movedY_qlty_widiv_comp = qlty_widiv_comp %>% filter(Moved == "YES")
```

how does the distribution of age difference look like
```{r}
with(movedY_qlty_widiv_comp, hist(QltyDiff, breaks = 20))
```

gives convergence issues with the 3 random effects, Year has very low variance so removed. Don't consider interaction because of low sample size
```{r}
widiv_QltyDiff = list()

library(glmmTMB)
#widiv_QltyDiff[[1]] = glmmTMB(QltyDiff ~ stdSex * stdStatus + (1|Band) + (1|Site), family = "gaussian", data = movedY_qlty_widiv_comp)
widiv_QltyDiff[[1]] = glmmTMB(QltyDiff ~ stdSex + stdStatus +  (1|Band) + (1|Site), family = "gaussian", data = movedY_qlty_widiv_comp)
widiv_QltyDiff[[2]] = glmmTMB(QltyDiff ~ stdSex +   (1|Band) + (1|Site), family = "gaussian", data = movedY_qlty_widiv_comp)
widiv_QltyDiff[[3]] = glmmTMB(QltyDiff ~ stdStatus +   (1|Band) + (1|Site), family = "gaussian", data = movedY_qlty_widiv_comp)
widiv_QltyDiff[[4]] = glmmTMB(QltyDiff ~ 1 + (1|Band) + (1|Site), family = "gaussian", data = movedY_qlty_widiv_comp)
```

```{r}
hist(residuals(widiv_QltyDiff[[1]], type = "pearson"))
```

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
library(MuMIn)
AIC_widiv_QltyDiff = model.sel(widiv_QltyDiff, rank = "AICc")
modavg_widiv_QltyDiffD6 = model.avg(widiv_QltyDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
widiv_QltyDiff_EstimatesD6 = cbind(summary(modavg_widiv_QltyDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_widiv_QltyDiffD6))
```
```{r}
widiv_QltyDiff_EstimatesD6
```
No effect of any of the considered variables

```{r}
write.table(widiv_QltyDiff_EstimatesD6, "estimates_D6_widiv_QltyDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Laying date difference

```{r}
lay_widiv_comp = widow_div_comp %>% dplyr::select(Band, Year, Site, Sex, LayingDiff, Status) %>% filter(!is.na(LayingDiff))
```

standardisation of the explanatory variables
```{r}
library(arm)
lay_widiv_comp = lay_widiv_comp %>% mutate(stdSex = rescale(Sex), stdStatus = rescale(Status))
```

how does the distribution of age difference look like
```{r}
with(lay_widiv_comp, hist(LayingDiff, breaks = 20))
```
alright

Having Year, Site and Band as random effects caused some convergence issues, so I don't consider Site as it has a variance almost equal to zero.
```{r}
widiv_LayingDiff = list()

library(glmmTMB)
widiv_LayingDiff[[1]] = glmmTMB(LayingDiff ~ stdSex * stdStatus + (1|Year) + (1|Band) + (1|Site), family = "gaussian", data = lay_widiv_comp)
widiv_LayingDiff[[2]] = glmmTMB(LayingDiff ~ stdSex + stdStatus + (1|Year) + (1|Band) + (1|Site), family = "gaussian", data = lay_widiv_comp)
widiv_LayingDiff[[3]] = glmmTMB(LayingDiff ~ stdSex +  (1|Year) + (1|Band) + (1|Site), family = "gaussian", data = lay_widiv_comp)
widiv_LayingDiff[[4]] = glmmTMB(LayingDiff ~ stdStatus +  (1|Year) + (1|Band) + (1|Site), family = "gaussian", data = lay_widiv_comp)
widiv_LayingDiff[[5]] = glmmTMB(LayingDiff ~ 1 + (1|Year) +  (1|Band) + (1|Site), family = "gaussian", data = lay_widiv_comp)
```

```{r}
hist(residuals(widiv_LayingDiff[[1]], type = "pearson"))
```
looks alright

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
library(MuMIn)
AIC_widiv_LayingDiff = model.sel(widiv_LayingDiff, rank = "AICc")
modavg_widiv_LayingDiffD6 = model.avg(widiv_LayingDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
widiv_LayingDiff_EstimatesD6 = cbind(summary(modavg_widiv_LayingDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_widiv_LayingDiffD6))
```
```{r}
widiv_LayingDiff_EstimatesD6
```
No effect of any of the considered variables

```{r}
write.table(widiv_LayingDiff_EstimatesD6, "estimates_D6_widiv_LayingDiff_TBMU.csv",row.names = TRUE, sep = ",")
```


### Reprod success difference

```{r}
fledge_widiv_comp = widow_div_comp %>% dplyr::select(Band, Year, Site, Sex, FledgeDiff, Status) %>% filter(!is.na(FledgeDiff))
```

standardisation of the explanatory variables
```{r}
library(arm)
fledge_widiv_comp = fledge_widiv_comp %>% mutate(stdSex = rescale(Sex), stdStatus = rescale(Status), FledgeDiff = as.integer(if_else(FledgeDiff == -1, 0, if_else(FledgeDiff == 0, 0.5, 1))))
```


Having Year, Site and Band as random effects caused some convergence issues, so I don't consider Site as it has a variance almost equal to zero.
```{r}
widiv_FledgeDiff = list()

library(glmmTMB)
widiv_FledgeDiff[[1]] = glmmTMB(FledgeDiff ~ stdSex * stdStatus + (1|Year) + (1|Band) + (1|Site), family = "binomial", data = fledge_widiv_comp)
widiv_FledgeDiff[[2]] = glmmTMB(FledgeDiff ~ stdSex + stdStatus + (1|Year) + (1|Band) + (1|Site), family = "binomial", data = fledge_widiv_comp)
widiv_FledgeDiff[[3]] = glmmTMB(FledgeDiff ~ stdSex +  (1|Year) + (1|Band) + (1|Site), family = "binomial", data = fledge_widiv_comp)
widiv_FledgeDiff[[4]] = glmmTMB(FledgeDiff ~ stdStatus +  (1|Year) + (1|Band) + (1|Site), family = "binomial", data = fledge_widiv_comp)
widiv_FledgeDiff[[5]] = glmmTMB(FledgeDiff ~ 1 + (1|Year) +  (1|Band) + (1|Site), family = "binomial", data = fledge_widiv_comp)
```

Ranking all the models in increasing order of AICc and taking a subset to get to 95% of cumulative weights
```{r}
library(MuMIn)
AIC_widiv_FledgeDiff = model.sel(widiv_FledgeDiff, rank = "AICc")
modavg_widiv_FledgeDiffD6 = model.avg(widiv_FledgeDiff, beta = "none", subset = delta <= 6)
```

```{r, include=FALSE}
widiv_FledgeDiff_EstimatesD6 = cbind(summary(modavg_widiv_FledgeDiffD6)$coefmat.subset[,c(1,3)], confint(modavg_widiv_FledgeDiffD6))
```
```{r}
widiv_FledgeDiff_EstimatesD6
```
No effect of any of the considered variables

```{r}
write.table(widiv_FledgeDiff_EstimatesD6, "estimates_D6_widiv_FledgeDiff_TBMU.csv",row.names = TRUE, sep = ",")
```